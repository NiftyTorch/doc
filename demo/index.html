<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Demo - NiftyTorch Documentation</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Demo";
    var mkdocs_page_input_path = "demo.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> NiftyTorch Documentation</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">NiftyTorch</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../attention/">Attention</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../layers/">Layers</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../loader/">Loader</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../loss/">Loss</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../models/">Models</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../training/">Training</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../transformations/">Transformations</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../license/">Licence</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Demo</a>
    <ul class="current">
    </ul>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">NiftyTorch Documentation</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Demo</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="niftytorch">NiftyTorch</h1>
<p>NiftyTorch is a python API for deploying deep neural networks for Neuroimaging research.</p>
<p>The goal is to provide a one stop API using which the users can perform classification tasks, Segmentation tasks and Image Generation tasks.
The intended audience are the members of neuroimaging who would like to explore deep learning but have no background in coding.</p>
<h1 id="getting-started">Getting Started</h1>
<h2 id="setting-up-the-environment">Setting up the environment</h2>
<p>Open command shell (e.g. Terminal in MacOS) and create a virtual environment using below commands. This will allow the installation of NiftyTorch dependencies indepednent of your local installs. This is inparticular useful if NiftyTorch is being used on an external server. This document that <a href="https://docs.conda.io/projects/conda/en/latest/user-guide/install/">conda</a> is already installed on your server or local machine. </p>
<ul>
<li><code>%%bash</code> indicates that the code inside the cell should be run on command shell. If you use Jupyter notebook to run your code, the command will automatically run on command shell. </li>
</ul>
<pre><code class="bash">%%bash
# create a virutal environment using python 3.6 or above
conda create -n nt python=3.6 
</code></pre>

<p>Activate the virtual environment.</p>
<pre><code class="python"># %%bash
conda activate nt
</code></pre>

<h2 id="install-dependencies">Install dependencies</h2>
<p>install below softwares and libraries:</p>
<pre><code class="bash">%%bash
# install the latest version of pytorch and torchvision
conda install pytorch torchvision -c pytorch

# install NiftyTorch 
pip install niftytorch

# if NiftyTorch generated error about pytorch version, use below command to change your version
# pip install torchvision==0.5.0
# pip install torch==1.4.0
# pip install nipy==0.4.2
# pip install numpy==1.18.1
# pip install pandas==1.0.3
# pip install matplotlib==3.2.1
# pip install Optuna==1.3.0
</code></pre>

<h2 id="run-an-example-deep-learning-classifier-on-your-data-using-niftytorch">Run an example deep learning classifier on your data using NiftyTorch</h2>
<p>We assumed the your data is structured as follow. SubjectIDs should be randomly assigned to training, validation and test sets. </p>
<p>Here <code>t1w.nii.gz</code> and <code>t2w.nii.gz</code> are included as examples. Users can include any modality (or derived maps) of interest. Data should be in nifti format.</p>
<pre><code>StudyName
└───train
│   └───subjectID
│   │       t1w.nii.gz
│   │       t2w.nii.gz
│   └───subjectID
│   │       t1w.nii.gz
│   │       t2w.nii.gz               
│   │   ...
└───val
│   └───subjectID
│   │       t1w.nii.gz
│   │       t2w.nii.gz
│   └───subjectID
│   │       t1w.nii.gz
│   │       t2w.nii.gz               
│   │   ...
└───test
│   └───subjectID
│   │       t1w.nii.gz
│   │       t2w.nii.gz
│   └───subjectID
│   │       t1w.nii.gz
│   │       t2w.nii.gz               
│   │   ...

</code></pre>

<p>Now you are ready to use NiftyTorch. Run below code in python environment (or in Jupyter notebook) to train a deep learning classifier on your data.<br />
Here we show an example using the <a href="https://arxiv.org/abs/1603.05279">XNOR-Net</a> or <a href="https://en.wikipedia.org/wiki/AlexNet#cite_note-quartz-1">Alex-Net</a>.  </p>
<p>The classifier is training a network to predict Alzheimer's patient from cognitively healhty individuals using <code>t1w</code> and <code>t2w</code> MRI. The labels should be stored in a separate CSV file (here called <code>labels.csv</code>), and should contain a column with the sampe subject IDS (here the column name is <code>Subject</code>) and a column with disease status (e.g. 0 for healthy controls and 1 for AD patients - here the column name is <code>diease</code>). </p>
<p><code>SubjecID</code> can be any subject ID of your choice. for example: <code>sub-01</code>, <code>sub-02</code>, ... . We plan to add BIDS compatibility. </p>
<p>Here is an example of the <code>labels.csv</code> data.</p>
<pre><code class="python">import pandas as pd
study_folder = &quot;/example/farshid/img/data/StudyName&quot;
labels = pd.read_csv(study_folder+&quot;/labels.csv&quot;)
labels.head()
</code></pre>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Subject</th>
      <th>age</th>
      <th>gender</th>
      <th>diagnosis</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>SUBJ01</td>
      <td>70</td>
      <td>M</td>
      <td>1</td>
    </tr>
    <tr>
      <td>1</td>
      <td>SUBJ02</td>
      <td>65</td>
      <td>M</td>
      <td>1</td>
    </tr>
    <tr>
      <td>2</td>
      <td>SUBJ03</td>
      <td>69</td>
      <td>F</td>
      <td>0</td>
    </tr>
    <tr>
      <td>3</td>
      <td>SUBJ04</td>
      <td>71</td>
      <td>F</td>
      <td>1</td>
    </tr>
    <tr>
      <td>4</td>
      <td>SUBJ05</td>
      <td>68</td>
      <td>M</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>

<p>Let's train the model.</p>
<h3 id="xnor-net">XNOR-net</h3>
<p>Below is an example of training a XNOR-Net for disease classification. Hyper-parameters should be optimized for your application and dataset. Other parameters, such as number of epochs, should be modified accordingly as well. We included some of the features of NiftyTorch in below example, such as:
* Incorporate demographic information through attention gate: <code>demographic = ['age','gender']</code>
* Assign specific data for training: <code>file_type = ('t1w.nii.gz','t2w.nii.gz')</code>. You can use single or multiple data inputs as training channels. Note that if this is not assigned, all the images in subject folder will be used. 
* Data parallelization: <code>device_ids = ['cuda:2','cuda:5']</code>. Data will be allocated to multiple GPUs. Note that this can slow down the training process due to the additional background integration. This option is only required in rare cases that each sample size is large relative to the GPU RAM.
* <code>cuda = 'cuda:5'</code> assign GPU number 5 for this task. Use <code>nvidia-smi</code> to check the status of your GPU device. </p>
<pre><code class="python"># import libraries
import torch
import niftytorch as nt
from nt.Models.XNOR_NET import train_xnornet
from torchvision import transforms
import torch.nn as nn

# create data-to-tensor transform
data_transforms = transforms.Compose([transforms.ToTensor()])

# add path to your data folder
data_folder = &quot;/example/farshid/img/data/StudyName&quot;

# add path to labels
data_csv = &quot;/example/farshid/img/data/StudyName/labels.csv&quot;

# train classifier using XNOR Net
train = train_xnornet()

# set training parameters
# training will be done using:
# Entries in the 'Subject' column
# Labels: class_label = 'diagnosis'
train.set_params(
    num_classes = 2,
    in_channels = 2,
    data_folder = data_folder,
    data_csv = data_csv,
    channels = [1,2,4,2,1],
    kernel_size = [3,5,5,3,1],
    strides = [1,2,2,2,1],
    padding = [1,1,1,1,1],
    groups = [1,1,1,1,1],
    data_transforms = data_transforms,
    l2 = 3e-4,
    learning_rate = 1e-3,
    step_size = 10,
    gamma = 0.1,
    cuda = 'cuda:5',
    device_ids = ['cuda:2','cuda:5'],
    batch_size = 128,
    image_scale = 128,
    num_epochs = 20,
    optimizer = torch.optim.Adam,
    filename_label = 'Subject',
    class_label = 'diagnosis',
    file_type = ('t1w.nii.gz','t2w.nii.gz'),
    demographic = ['age','gender']
    )
train.train()
</code></pre>

<h3 id="important-note-before-applying-prediction">Important note before applying prediction</h3>
<blockquote>
<p>Users should carefully choose the loss function and the optimizer depending on the data and application. For example, imbalanced datasets, which is common in medical imaging, require a loss function that incorporates class imbalance (such as <code>Focal Loss</code> or <code>Weighted Cross Entropy</code> - See Loss Documentation for more details).  </p>
<p>Note that the performance of any network dependents on the optimization of the hyperparamters. User should optimize network for optimum performance. <strong>NiftyTorch</strong> has a module that helps with the hyperparameter optimization, which is detailed in <strong>Demo 3: Automated Hyperparamter Optimization</strong>.</p>
</blockquote>
<h3 id="prediction-applying-the-classifier">Prediction (applying the classifier)</h3>
<p>The next step would be to perform the classification on the test data to see how well the model has learned the weights after the completion of the training process.</p>
<p>Note that the testing parameters is same as that of the training parameters.</p>
<pre><code class="python">import torch.nn as nn
# define batch_size for testing
batch_size = 32

# define the scale of image while tesing
image_scale = 128

# define the loss function for evaluation during testing
test_criterion = nn.CrossEntropyLoss()

# device on the network would be trained
device = torch.device('cuda:5')

# called the predict function which has the parameters internally stored
train.predict(data_folder = data_folder,
              data_csv = data_csv,
              data_transforms = data_transforms,
              filename_label = 'Subject',
              class_label = 'disease',
              image_scale = image_scale,
              batch_size = batch_size,
              num_workers = 4,
              test_criterion = test_criterion, 
              file_type = ('t1w.nii.gz','t2w.nii.gz'),
              demographic = ['age','gender'],
              device = device)
</code></pre>

<p>The output of this stage will be the predicted classes and the overal accuracy over the testing samples. The prediction will be reported in the form of <code>SubjectID tensor (predicted class, device=GPU used)</code>
For example, below are prediction results of 7 subjects from testing: </p>
<pre><code>sub-09935 tensor(0, device='cuda:5')
sub-04622 tensor(1, device='cuda:5')
sub-05725 tensor(1, device='cuda:5')
sub-00008 tensor(1, device='cuda:5')
sub-03721 tensor(0, device='cuda:5')
sub-01717 tensor(0, device='cuda:5')
sub-01818 tensor(1, device='cuda:5')
test Classification Loss: 0.5435 Acc: 0.7436
Testing complete in 0m 38s
</code></pre>

<p>Congradulations, you have a Deep Learning classifier now. To save the the weights of your trained network you can use <code>get_model</code> function in the train object.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="../license/" class="btn btn-neutral" title="Licence"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../license/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
